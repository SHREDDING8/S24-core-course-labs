# Kubernetes StatefulSet

## StatefulSet Exploration and Optimization

### Get kubectl info

```shell
(venv) shredding@SHREDDING-2 k8s % kubectl get po,sts,svc,pvc
NAME                                       READY   STATUS      RESTARTS      AGE
pod/python-app-python-854646957c-96nrx     1/1     Running     3 (9d ago)    23d
pod/python-app-python-854646957c-jdtcc     1/1     Running     3 (9d ago)    23d
pod/python-app-python-854646957c-xt5ph     1/1     Running     3 (9d ago)    23d
pod/python-deployment-cf645b767-4r8jm      1/1     Running     4 (9d ago)    30d
pod/python-deployment-cf645b767-7j4hx      1/1     Running     4 (9d ago)    30d
pod/python-deployment-cf645b767-ksgct      1/1     Running     4 (9d ago)    30d
pod/python-postinstall-hook                0/1     Completed   0             23d
pod/vault-0                                1/1     Running     2 (43s ago)   16d
pod/vault-agent-injector-dbfc5cd77-m8ffs   0/1     Running     2 (9d ago)    16d

NAME                     READY   AGE
statefulset.apps/vault   1/1     16d

NAME                               TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/app-python                 LoadBalancer   10.99.169.216    <pending>     8080:31152/TCP      30d
service/kubernetes                 ClusterIP      10.96.0.1        <none>        443/TCP             30d
service/python-app-python          LoadBalancer   10.96.69.197     <pending>     8080:32276/TCP      23d
service/python-service             LoadBalancer   10.111.209.63    <pending>     8080:31584/TCP      30d
service/vault                      ClusterIP      10.100.132.232   <none>        8200/TCP,8201/TCP   16d
service/vault-agent-injector-svc   ClusterIP      10.99.241.170    <none>        443/TCP             16d
service/vault-internal             ClusterIP      None             <none>        8200/TCP,8201/TCP   16d
```

### Check minikube service

```shell
(venv) shredding@SHREDDING-2 k8s % minikube service python-app-python
|-----------|-------------------|-------------|---------------------------|
| NAMESPACE |       NAME        | TARGET PORT |            URL            |
|-----------|-------------------|-------------|---------------------------|
| default   | python-app-python | http/8080   | http://192.168.49.2:32276 |
|-----------|-------------------|-------------|---------------------------|
üèÉ  Starting tunnel for service python-app-python.
|-----------|-------------------|-------------|------------------------|
| NAMESPACE |       NAME        | TARGET PORT |          URL           |
|-----------|-------------------|-------------|------------------------|
| default   | python-app-python |             | http://127.0.0.1:50606 |
|-----------|-------------------|-------------|------------------------|
üéâ  Opening service default/python-app-python in default browser...
```

### Check statefulset

```shell
(venv) shredding@SHREDDING-2 k8s %  kubectl describe sts python
Name:               python-app-python
Namespace:          default
CreationTimestamp:  Tue, 3 Nov 2024 17:26:56 +0300
Selector:           app.kubernetes.io/instance=python,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/version=0.1.0
Labels:             app.kubernetes.io/instance=python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/version=0.1.0
Annotations:        meta.helm.sh/release-name: python
                    meta.helm.sh/release-namespace: default
Replicas:           3 desired | 3 total
Update Strategy:    RollingUpdate
  Partition:        0
Pods Status:        3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  Labels:           app.kubernetes.io/instance=python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/version=0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-config.txt: internal/data/server/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   python-app:
    Image:      shredding228/server-app:latest
    Port:       8080/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:8080/healthcheck delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:8080/healthcheck delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      MY_PASSWORD:     <set to the key 'password' in secret 'credentials'>              Optional: false
      CONFIG_MAP_VAR:  <set to the key 'env-var' of config map 'app-python-configmap'>  Optional: false
      RELEASE_NAME:    python
      SLEEP_TIME:      5
    Mounts:
      /app/config_map from config-volume (rw)
      /app/data from visits-data (rw)
  Volumes:
   config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      app-python-configmap
    Optional:  false
   visits-data:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     
    SizeLimit:  500Mi
Volume Claims:
  Name:          visits-data
  StorageClass:  
  Labels:        <none>
  Annotations:   <none>
  Capacity:      1Gi
  Access Modes:  [ReadWriteOnce]
Events:
  Type    Reason            Age    From                    Message
  ----    ------            ----   ----                    -------
  Normal  SuccessfulCreate  8m5s   statefulset-controller  create Claim visits-data-python-app-python-0 Pod python-app-python-0 in StatefulSet python-app-python success
  Normal  SuccessfulCreate  8m5s   statefulset-controller  create Pod python-app-python-0 in StatefulSet python-app-python successful
  Normal  SuccessfulCreate  7m53s  statefulset-controller  create Claim visits-data-python-app-python-1 Pod python-app-python-1 in StatefulSet python-app-python success
  Normal  SuccessfulCreate  7m53s  statefulset-controller  create Pod python-app-python-1 in StatefulSet python-app-python successful
  Normal  SuccessfulCreate  7m41s  statefulset-controller  create Claim visits-data-python-app-python-2 Pod python-app-python-2 in StatefulSet python-app-python success
  Normal  SuccessfulCreate  7m41s  statefulset-controller  create Pod python-app-python-2 in StatefulSet python-app-python successful
```

### Check visits file

Firstly, I accessed my app from different tabs and modes in your browser.

After it, I accessed the visits file:

```shell
(venv) shredding@SHREDDING-2 k8s %  kubectl exec pod/python-python-app-0 -- cat data/visits.txt
4
(venv) shredding@SHREDDING-2 k8s %  kubectl exec pod/python-python-app-1 -- cat data/visits.txt
1
(venv) shredding@SHREDDING-2 k8s %  kubectl exec pod/python-python-app-2 -- cat data/visits.txt
22 
```

### Results
Because each pod has its own persistent volume and the service balancer cannot ensure perfect balance between them, the number of visits varies amongst pods.
### Ordering Guarantee
StatefulSet apps do not require ordering guarantees because the StatefulSet itself ensures that each of its pods has a unique identity and consistent network identification. As a result, the pods can retrieve their previous state from storage and continue their operations even if they are rescheduled on different nodes. Therefore, the StatefulSet's maintenance of pod order and uniqueness makes ordering guarantees unnecessary for the proper functioning of stateful applications.

### Implement a way to instruct the StatefulSet controller to launch or terminate all Pods in parallel

Add `spec.podManagementPolicy: Parallel` in `statefulset.yaml`

### Explore Update Strategies

Source: <https://spot.io/resources/kubernetes-autoscaling/5-kubernetes-deployment-strategies-roll-out-like-the-pros/>

* Rolling deployment‚Äîthe default strategy that allows you to update a set of pods without downtime. It replaces pods running the old version of the application with the new version, one by one.
* Recreate deployment‚Äîan all-or-nothing method that lets you update an application instantly, with some downtime. It terminates all pods and replaces them with the new version.
* Ramped slow rollout‚Äîrolls out replicas of the new version, while in parallel, shutting down old replicas. * Best-effort controlled rollout‚Äîspecifies a ‚Äúmax unavailable‚Äù parameter which indicates what percentage of existing pods can be unavailable during the upgrade, enabling the rollout to happen much more quickly.
* Blue/green deployment‚Äîa deployment strategy in which you create two separate, but identical environments, and over to the new environment.
* Canary deployment‚Äîuses a progressive delivery approach, with one version of the application serving most users, and another, newer version serving a small pool of test users. The test deployment is rolled out to more users if it is successful.
* Shadow deployment‚Äîthe new version of the application (the ‚Äúshadow‚Äù version) receives real-world traffic alongside the current version, but without affecting end-users.
* A/B testing‚Äîrolls out two or more versions of an application feature to a subset of users simultaneously to see which one performs better in terms of user engagement, error rates, or other KPIs.